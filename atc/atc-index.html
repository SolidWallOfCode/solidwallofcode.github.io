
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Apache Traffic Control &#8212; AMC Traffic Server Documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinxdoc.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Partial Object Caching" href="../poc/poc-index.html" />
    <link rel="prev" title="TSConfig / Lua" href="../tsconfig-lua.en.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../poc/poc-index.html" title="Partial Object Caching"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../tsconfig-lua.en.html" title="TSConfig / Lua"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">SWOC Docs</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Apache Traffic Control</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="apache-traffic-control">
<h1>Apache Traffic Control<a class="headerlink" href="#apache-traffic-control" title="Permalink to this headline">¶</a></h1>
<p>My notes on creating a prototype CDN using ATC and ATS. All of this is specifically for CentOS 8.</p>
<section id="generic-preparation">
<h2>Generic Preparation<a class="headerlink" href="#generic-preparation" title="Permalink to this headline">¶</a></h2>
<p>Certain bits of data applying to the overall CDN must be decided before installing. This includes</p>
<ul class="simple">
<li><p>A domain name for the CDN.</p></li>
<li><p>A domain name for the CDN infrastructure (which can be the same as the CDN).</p></li>
<li><p>Host names for the hosts on which Traffic Control components will installed.</p></li>
<li><p>Admin user name and password.</p></li>
<li><p>Vault user name and password.</p></li>
</ul>
<p>Various bits of the install will ask for these values, it is critical to be consistent.</p>
<p>It is possible to decide on an install path but unless it is absolutely critical to have the
installs in a specific location it is <em>much</em> easier to use the “/opt” default built in to Traffic
Control. Similarly for the “traffic_ops” and “traffic_vault” users in the databases - I have
verified it is possible to change them but it’s a lot of work for very little reward. I’d avoid it.</p>
</section>
<section id="traffic-ops">
<h2>Traffic Ops<a class="headerlink" href="#traffic-ops" title="Permalink to this headline">¶</a></h2>
<p>The Traffic Ops host will host both the Postgresql database and the ATC “traffic_ops” package.
“traffic_ops” is the central engine of ATC - most other components connect to “traffic_ops” and
treat it as the source of truth. The current recommendation is to install the database and
“traffic_ops” on the same host to avoid having to configure external access to the database.</p>
<ol class="arabic">
<li><p>Install Postgresql. An install script can be obtained from <a class="reference external" href="https://www.postgresql.org/download/linux/redhat/">here</a>
or this one can be used (which was obtained from that webpage).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Install the repository RPM:</span>
<span class="n">sudo</span> <span class="n">dnf</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">download</span><span class="o">.</span><span class="n">postgresql</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">pub</span><span class="o">/</span><span class="n">repos</span><span class="o">/</span><span class="n">yum</span><span class="o">/</span><span class="n">reporpms</span><span class="o">/</span><span class="n">EL</span><span class="o">-</span><span class="mi">8</span><span class="o">-</span><span class="n">x86_64</span><span class="o">/</span><span class="n">pgdg</span><span class="o">-</span><span class="n">redhat</span><span class="o">-</span><span class="n">repo</span><span class="o">-</span><span class="n">latest</span><span class="o">.</span><span class="n">noarch</span><span class="o">.</span><span class="n">rpm</span>

<span class="c1"># Disable the built-in PostgreSQL module:</span>
<span class="n">sudo</span> <span class="n">dnf</span> <span class="o">-</span><span class="n">qy</span> <span class="n">module</span> <span class="n">disable</span> <span class="n">postgresql</span>

<span class="c1"># Install PostgreSQL:</span>
<span class="n">sudo</span> <span class="n">dnf</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">postgresql13</span><span class="o">-</span><span class="n">server</span>

<span class="c1"># Optionally initialize the database and enable automatic start:</span>
<span class="n">sudo</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">pgsql</span><span class="o">-</span><span class="mi">13</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">postgresql</span><span class="o">-</span><span class="mi">13</span><span class="o">-</span><span class="n">setup</span> <span class="n">initdb</span>
<span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">enable</span> <span class="n">postgresql</span><span class="o">-</span><span class="mi">13</span>
<span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">start</span> <span class="n">postgresql</span><span class="o">-</span><span class="mi">13</span>
</pre></div>
</div>
<p>Differences:</p>
<ul class="simple">
<li><p>No configuration to enable access from other hosts. All access will be from this host.</p></li>
<li><p>Root access is via user id, not password.</p></li>
</ul>
<p>As of Traffic Control 6.0.0 and Postgresql 13 (at this time, the stable version of each), there is
a mismatch between how Postgresql and Traffic Control expect to perform password authentication.
To fix this, Postgresql needs to be adjusted to use an older method.</p>
<p>Edit “/var/lib/pgsql/13/data/postgresql.conf” and make this change</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">password_encryption</span> <span class="o">=</span> <span class="n">md5</span>       <span class="c1"># md5 or scram-sha-256</span>
</pre></div>
</div>
<p>It may or not be necessary to also change “/var/lib/pgsql/13/data/pg_hba.conf” to enable “md5”
password authentication. This involves changing “scram-sha-256” to “md5”.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># IPv4 local connections:</span>
<span class="n">host</span>    <span class="nb">all</span>             <span class="nb">all</span>             <span class="mf">127.0.0.1</span><span class="o">/</span><span class="mi">32</span>            <span class="n">md5</span>
<span class="c1"># IPv6 local connections:</span>
<span class="n">host</span>    <span class="nb">all</span>             <span class="nb">all</span>             <span class="p">::</span><span class="mi">1</span><span class="o">/</span><span class="mi">128</span>                 <span class="n">md5</span>
</pre></div>
</div>
<p>If this is not done, you may see this error from “traffic_ops”</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pq</span><span class="p">:</span> <span class="n">unknown</span> <span class="n">authentication</span> <span class="n">response</span><span class="p">:</span> <span class="mi">10</span>
</pre></div>
</div>
</li>
<li><p>Install <a class="reference external" href="https://fedoraproject.org/wiki/EPEL">EPEL</a> which provides some of the “traffic_ops” requirements.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">dnf</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">epel</span><span class="o">-</span><span class="n">release</span>
</pre></div>
</div>
</li>
<li><p>Install the “traffic_ops” RPM. This should automatically install all dependencies.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">dnf</span> <span class="n">install</span> <span class="o">--</span><span class="n">enablerepo</span><span class="o">=</span><span class="n">powertools</span> <span class="o">--</span><span class="n">enablerepo</span><span class="o">=</span><span class="n">epel</span> <span class="o">-</span><span class="n">y</span> <span class="n">traffic_ops</span><span class="o">-</span><span class="mf">6.0.0</span><span class="o">-</span><span class="mf">11512.e4469</span><span class="n">f55</span><span class="o">.</span><span class="n">el8</span><span class="o">.</span><span class="n">x86_64</span><span class="o">.</span><span class="n">rpm</span>
</pre></div>
</div>
</li>
<li><p>Initialize the databases.</p>
<p>Run a shell as the “postgres” user.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">su</span> <span class="o">-</span><span class="n">c</span> <span class="s2">&quot;bash -l&quot;</span> <span class="o">-</span> <span class="n">postgress</span>
</pre></div>
</div>
<p>Create the “traffic_ops” user, in this case with the password “vgl”. In production this should be
something a bit more secure. Because of the fragility of the install process, a “traffic_vault” user
must also be created or the Traffic Vault database will not be populated <a class="footnote-reference brackets" href="#id2" id="id1">1</a>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">psql</span>
<span class="n">CREATE</span> <span class="n">USER</span> <span class="n">traffic_ops</span> <span class="k">with</span> <span class="n">encrypted</span> <span class="n">password</span> <span class="s1">&#39;vgl&#39;</span><span class="p">;</span>
<span class="n">CREATE</span> <span class="n">USER</span> <span class="n">traffic_vault</span> <span class="k">with</span> <span class="n">encrypted</span> <span class="n">password</span> <span class="s1">&#39;vgl&#39;</span><span class="p">;</span>
\<span class="n">q</span>
</pre></div>
</div>
<p>If doing this by hand the terminal output should look like</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ psql
psql (13.4)
Type &quot;help&quot; for help.

postgres=# CREATE USER traffic_ops with encrypted password &#39;vgl&#39;;
CREATE ROLE
postgres=# CREATE USER traffic_vault with encrypted password &#39;vgl&#39;;
CREATE ROLE
postgres=# \q
$
</pre></div>
</div>
<p>Then at the shell command prompt (<em>not</em> in the <code class="docutils literal notranslate"><span class="pre">psql</span></code> environment) create the databases.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">createdb</span> <span class="n">traffic_ops</span> <span class="o">--</span><span class="n">owner</span> <span class="n">traffic_ops</span>
<span class="n">createdb</span> <span class="n">traffic_vault</span> <span class="o">--</span><span class="n">owner</span> <span class="n">traffic_vault</span>
</pre></div>
</div>
<p>Then <code class="docutils literal notranslate"><span class="pre">exit</span></code> from the “postgres” user shell.</p>
</li>
<li><p>Finalization</p>
<p>The script “/opt/traffic_ops/install/bin/postinstall” needs to be invoked as root. Unfortunately
the check for postgresql superuser may not work. Line 38 may need to be changed to</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>if [[ ! $(su -c &#39;psql -c &quot;show is_superuser&quot;&#39; - postgres &lt;/dev/null 2&gt;/dev/null) =~ &#39;on&#39; ]]; then
</pre></div>
</div>
<p>At some point I will submit a PR to fix this.</p>
<p>For the “secrets”, this is still a bit of a mystery to me.</p>
</li>
<li><p>Network Configuration</p>
<p>TLS requires a certificates, which consist of a certificate file and corresponding a key. The
certificate is public and the key file private, the latter being essentially the “password” for
the certifcate. These can be anywhere as long as they are accessible to the “traffic_ops”
process. Do make sure the key file has restricted read access. The best locations are either in
“/etc/pki” or somewhere in the “traffic_ops” install directory (generally “/opt/traffic_ops”).
The location of these files is stored in the “cdn.conf” file in “/opt/traffic_ops/app/conf”. For
legacy reasons these are referenced by editing the URL for the <code class="docutils literal notranslate"><span class="pre">listen</span></code> key under the
<code class="docutils literal notranslate"><span class="pre">hypnotoad</span></code> key. In the query string of this URL are two keys, “cert” and “key”. The “cert”
value must be the absolute path to the certificate (“.pem”) file. The “key” value must the
absolute path to the key (“.key”) file.</p>
<p>Components that connect to Traffic Ops require the hostname to be in the certificate. The hostname
to check is pulled from the connection URL - that is, if Traffic Portal is set to connect to</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">atc</span><span class="o">-</span><span class="n">ops</span>
</pre></div>
</div>
<p>then the hostname “atc-ops” must be in the certificate. This can be done by making it the common
name or by putting it as a <code class="docutils literal notranslate"><span class="pre">DNS</span></code> entry in the SAN data. See the certificate generation scripts
for examples of how to do this.</p>
<p>To allow external connections from Traffic Portal the TLS port must opened in the firewall. This is
done with</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span> <span class="o">--</span><span class="n">permanent</span> <span class="o">--</span><span class="n">zone</span><span class="o">=</span><span class="n">public</span> <span class="o">--</span><span class="n">add</span><span class="o">-</span><span class="n">service</span><span class="o">=</span><span class="n">https</span>
<span class="n">sudo</span> <span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span> <span class="o">--</span><span class="n">reload</span>
</pre></div>
</div>
<p>To enable other components to communicate securely with Traffic Ops those systems must be able to
verify the certicate installed on Traffic Ops. This in turns requires installing the corresponding
root certificate on the host with the component that must connect to Traffic Ops.</p>
<ol class="arabic simple">
<li><p>Copy the root certificate to “/usr/share/pki/ca-trust-sources/anchors”.</p></li>
<li><p>Run the (privileged) command <code class="docutils literal notranslate"><span class="pre">update-ca-trust</span></code>.</p></li>
</ol>
</li>
</ol>
<p class="rubric">References</p>
<ul class="simple">
<li><p><a class="reference external" href="https://traffic-control-cdn.readthedocs.io/en/latest/admin/traffic_ops.html">Installing Traffic Ops</a></p></li>
<li><p><a class="reference external" href="https://www.postgresql.org/download/linxu/redhat">Installing Postgresql</a></p></li>
</ul>
<p class="rubric">Notes</p>
<dl>
<dt>postgresql</dt><dd><p><code class="docutils literal notranslate"><span class="pre">createdb</span></code> is a command line tool, not an SQL command used inside the <code class="docutils literal notranslate"><span class="pre">psql</span></code> context.</p>
<p>Switching user id to “postgres” is needed only for root database control. This setup will be
listening on the standard postgresql port on localhost (IPv4 and IPv6) which is what “traffic_ops”
will use to perform its operations, logging as the user created for it.</p>
<p>Do <em>not</em> install the standard postgresql package - that causes problems. One effect seems to be
the command line utilities don’t get installed in “/usr/bin” which causes other problems.</p>
</dd>
</dl>
</section>
<section id="traffic-portal">
<h2>Traffic Portal<a class="headerlink" href="#traffic-portal" title="Permalink to this headline">¶</a></h2>
<p>The base instructions worked.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">--</span><span class="n">silent</span> <span class="o">--</span><span class="n">location</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">rpm</span><span class="o">.</span><span class="n">nodesource</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">setup_14</span><span class="o">.</span><span class="n">x</span> <span class="o">|</span> <span class="n">sudo</span> <span class="n">bash</span> <span class="o">-</span>
<span class="n">sudo</span> <span class="n">dnf</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">nodejs</span>
<span class="n">sudo</span> <span class="n">dnf</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">traffic_portal</span><span class="o">-</span><span class="mf">6.0.0</span><span class="o">-</span><span class="mf">11512.e4469</span><span class="n">f55</span><span class="o">.</span><span class="n">el8</span><span class="o">.</span><span class="n">x86_64</span><span class="o">.</span><span class="n">rpm</span>
</pre></div>
</div>
<p>It is expected that Traffic Portal will accept incoming browser requests and then make requests
to the Traffic Ops host for data.</p>
<p>The Traffic Portal listening ports must be opened in the CentOS firewall.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span> <span class="o">--</span><span class="n">permanent</span> <span class="o">--</span><span class="n">zone</span><span class="o">=</span><span class="n">public</span> <span class="o">--</span><span class="n">add</span><span class="o">-</span><span class="n">service</span><span class="o">=</span><span class="n">http</span>
<span class="n">sudo</span> <span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span> <span class="o">--</span><span class="n">permanent</span> <span class="o">--</span><span class="n">zone</span><span class="o">=</span><span class="n">public</span> <span class="o">--</span><span class="n">add</span><span class="o">-</span><span class="n">service</span><span class="o">=</span><span class="n">https</span>
<span class="n">sudo</span> <span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span> <span class="o">--</span><span class="n">reload</span>
</pre></div>
</div>
<p class="rubric">References</p>
<ul class="simple">
<li><p><a class="reference external" href="https://traffic-control-cdn.readthedocs.io/en/latest/admin/traffic_portal/installation.html">Installing Traffic Portal</a></p></li>
</ul>
</section>
<section id="traffic-server">
<h2>Traffic Server<a class="headerlink" href="#traffic-server" title="Permalink to this headline">¶</a></h2>
<p>This requires building an RPM for Traffic Server. This can be built from the Traffic Control
builder, but that builds ATS 8.x. I strongly recommend moving to ATS 9.1. However, this could be
adjusted easily in a local copy of the ATC repository. What makes this a bit complex is there are
at least three different versions available - two in the Traffic Control repository and one in the
Traffic Server respository.</p>
<p>The primary goal of the spec file is to put the Traffic Server install under a single directory,
except for the <code class="docutils literal notranslate"><span class="pre">systemd</span></code> support files which must go in “/usr/lib/systemd”.</p>
<p>One thing I noticed looking at the various efforts (including my own), all of them gave up on using
of <cite>%configure</cite>. Using this requires so many corrections to the paths that it’s easier overall to
run <code class="docutils literal notranslate"><span class="pre">./configure</span></code> directly. Other than that the difference seems to be more in how the files are
specified. The Traffic Control versions are more specific about the configuration files while the
Traffic Server based one is more specific about binary files and less so for configuration files. The
Traffic Control file also had some tweaks specifically related to Traffic Control.</p>
<p>The Traffic Server version also makes multiple packages, including a “devel” package which enables
building without having to do a full install (which can be annoying if Traffic Server is auto-started
by the install). I think this is a feature to keep when working on building the stats plugin.</p>
<p>The installed files can be moved around and still integrated with Traffic Control through the use of
Parameters in the Profile. There’s a good argument to be made to remove the excess “trafficserver”
intermediate directories as everything is under “/opt/trafficserver”.</p>
<p>My currenting working RPM spec <a class="reference external" href="https://github.com/solidwallofcode/ts-docs/blob/apache/atc/vgl-ts.spec">vgl-ts.spec</a>. I expect to make further changes,
incorporating some of the techniques from the Traffic Control versions.</p>
<p>To build the RPM several packages are needed on the build machine.</p>
<p>Base RPM tools.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">dnf</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">epel</span><span class="o">-</span><span class="n">release</span>
<span class="n">sudo</span> <span class="n">dnf</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">rpmdevtools</span>
</pre></div>
</div>
<p>Packages required by the ATS “.spec” file.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">dnf</span> <span class="o">--</span><span class="n">enablerepo</span><span class="o">=</span><span class="n">epel</span> <span class="o">--</span><span class="n">enablerepo</span><span class="o">=</span><span class="n">powertools</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">expat</span><span class="o">-</span><span class="n">devel</span> <span class="n">hwloc</span><span class="o">-</span><span class="n">devel</span> <span class="n">libcurl</span><span class="o">-</span><span class="n">devel</span> <span class="n">ncurses</span><span class="o">-</span><span class="n">devel</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">rpmbuild</span></code> command will put the output in “~/rpmbuild/RPMS” by default. This can be changed in
the “.spec” file by adding</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">_topdir</span> <span class="o">/</span><span class="n">path</span>
</pre></div>
</div>
</div></blockquote>
<p>The underlying directory structure (e.g. that the output goes in to “_topdir/RPMS” doesn’t seem
overridable.</p>
<p>The “astats_over_http” plugin is required to enable monitoring and statistics. This is no longer
part of the standard Traffic Server installation (it’s been replaced by “stats_over_http” which is
just enough different to not work). This will need to be obtained from the Traffic Control repository.
I need to work out the best way to build and package it - unfortunately building requires an
install of at least the development package from Traffic Server. For now it’s a single binary
which I copy by hand.</p>
</section>
<section id="administration">
<h2>Administration<a class="headerlink" href="#administration" title="Permalink to this headline">¶</a></h2>
<p>Before configuring any Traffic Server instances the CDN must be created in Traffic Ops.</p>
<p>It is not possible to immediately create those “servers” (records for ATS instances). Information
about the CDN must be created first. The steps for that are</p>
<ol class="arabic simple">
<li><p>Define a “division”.</p></li>
<li><p>Define a “region”.</p></li>
<li><p>Define a “location” (aka “physical location”).</p></li>
<li><p>Define a “cache group”.</p></li>
<li><p>Define a “profile” of type <code class="docutils literal notranslate"><span class="pre">ATS_PROFILE</span></code>. It works best if at least two are created, one for
mid-tier instances and another for edge.</p></li>
</ol>
<p>This sets up the basic CDN. Local configuration of Traffic Server depends on “Parameters”. These
must be defined and then attached to the profile used to configure the Traffic Server instance. The
Parameters required to configure a Traffic Server instance are</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 39%" />
<col style="width: 15%" />
<col style="width: 46%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Config File</p></th>
<th class="head"><p>Value</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>path</p></td>
<td><p>astats.config</p></td>
<td><p>_astats</p></td>
</tr>
<tr class="row-odd"><td><p>record_types</p></td>
<td><p>astats.config</p></td>
<td><p>122</p></td>
</tr>
<tr class="row-even"><td><p>allow_ip</p></td>
<td><p>astats.config</p></td>
<td><p>127.0.0.1</p></td>
</tr>
<tr class="row-odd"><td><p>location</p></td>
<td><p>astats.config</p></td>
<td><p>/opt/trafficserver/etc/trafficserver</p></td>
</tr>
<tr class="row-even"><td><p>traffic_server</p></td>
<td><p>package</p></td>
<td><p>9.1.0-el8.x86_64</p></td>
</tr>
<tr class="row-odd"><td><p>CONFIG proxy.config.http.server_ports</p></td>
<td><p>records.config</p></td>
<td><p>80 80:ipv6</p></td>
</tr>
</tbody>
</table>
<p>There are several types of Parameters, apparently distinguished by the “Config File” value and
sometimes the name. Generically each Parameter decribes a value / line to be placed in a configuration
file on the local system when running <code class="docutils literal notranslate"><span class="pre">t3c</span></code>. If other values in “records.config” are needed each
is added as a Parameter with the name of the configuration option, the value, and the config file
“records.config”, and then the Parameter attached to the profiles which in turn are attached to
Servers which correspond to Traffic Server instances. <code class="docutils literal notranslate"><span class="pre">t3c</span></code> works back from the host name to
the Server to the Profile to the Parameters when generating local configuration files.</p>
<p>There are some special cases.</p>
<p>A Config File of “package” indicates this is a package to install. The actual package name is
generated by concatenating the “name” and “value” of the Parameter. In this case, the package
“traffic_server.9.1.0-el8.x86_64” is to be installed. This calls out to <code class="docutils literal notranslate"><span class="pre">yum</span></code> to do the work
therefore if the package is already installed it is skipped. A package for Traffic Server is
required for the configuration generator to select the appropriate version of Traffic Server.
For this case take care the value exactly matches the installed Traffic Server package.</p>
<p>A Parameter Name of “location” indicate the location of the configuration file, not any of its
contents. This enables moving configuration files around, but is <em>required</em> for any configuration
file that is not part of the standard Traffic Server install. The common case for this is
plugins which require a configuration file - that must be specified in a Parameter.</p>
<p>Having created these Parameters, assign them to the Traffic Server profiles created earlier.
Although these Profiles will start out identical they will rapidly diverge as more detailed
configuration is needed.</p>
<section id="configuration">
<h3>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h3>
<p>Current <code class="docutils literal notranslate"><span class="pre">t3c</span></code> command.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">t3c</span> <span class="n">apply</span> <span class="o">--</span><span class="n">verbose</span> <span class="o">--</span><span class="n">run</span><span class="o">-</span><span class="n">mode</span><span class="o">=</span><span class="n">badass</span> \
               <span class="o">--</span><span class="n">cache</span><span class="o">-</span><span class="n">host</span><span class="o">-</span><span class="n">name</span><span class="o">=</span><span class="n">mid</span><span class="o">-</span><span class="n">ts</span> \
               <span class="o">--</span><span class="n">traffic</span><span class="o">-</span><span class="n">ops</span><span class="o">-</span><span class="n">user</span><span class="o">=</span><span class="n">admin</span> \
               <span class="o">--</span><span class="n">traffic</span><span class="o">-</span><span class="n">ops</span><span class="o">-</span><span class="n">password</span><span class="o">=</span><span class="n">vgl</span> \
               <span class="o">--</span><span class="n">traffic</span><span class="o">-</span><span class="n">ops</span><span class="o">-</span><span class="n">url</span><span class="o">=</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">atc</span><span class="o">-</span><span class="n">ops</span> \
               <span class="o">--</span><span class="n">git</span><span class="o">=</span><span class="n">no</span> \
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">--cache-host</span></code> is the key used to look up the Server in Traffic Ops which in turn controls the
Profile used to generate the configuration files.</p>
</section>
</section>
<section id="tools">
<h2>Tools<a class="headerlink" href="#tools" title="Permalink to this headline">¶</a></h2>
<p>Communications should be over TLS and that requires certificates. For the prototype I generated my
own root certificate and used it to sign the deployed certificates. It is expected that instead of
answering prompts, the scripts will be edited to put the appropriate values in the certificates.</p>
<p>Note - this is fine for proof of concept and prototyping, but not for actual production use.</p>
<p>Both scripts depend on a file name <a class="reference external" href="https://github.com/solidwallofcode/ts-docs/blob/apache/atc/openssl.cnf">openssl.cnf</a> which is defined by OpenSSL. This is the base
content, which should be tweaked as needed for local conditions.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># SPDX-License-Identifier: Apache-2.0

# Required environment variables
# PREFIX - used to set the common name.
# DN - used to select a root or signed distinguished name. Must be &quot;CA&quot; or &quot;Signed&quot;.

[ ca ]
default_ca = CA_default

[ CA_default ]
new_certs_dir = .

[ req ]
# Disable prompting so the commands use data from here!
prompt = no
distinguished_name = DN-${ENV::DN}

[DN-Signed]
CN = base.ex:role.${ENV::PREFIX}
O = TxnBox
C = S3
ST = Amber
L = Kolvir

[DN-CA]
CN = TxnBox CA ${ENV::PREFIX}
O = TxnBox
C = S3
ST = Confusion
L = Dazed


</pre></div>
</div>
<p>The script <a class="reference external" href="https://github.com/solidwallofcode/ts-docs/blob/apache/atc/ssh-gen-ca.sh">ssh-gen-ca.sh</a> can be used to generate the root certificate.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># SPDX-License-Identifier: Apache-2.0</span>
<span class="c1"># Generate root certificate.</span>
<span class="c1"># Note - after running this, no existing signed certificate will work with the new root CA.</span>

<span class="c1"># the openssl.cnf file requires two environment variables</span>
<span class="c1"># PREFIX - the certificate prexifx. This is used to decorate the distinguished name.</span>
<span class="c1"># DN - this must be &quot;CA&quot; for root certs and &quot;Signed&quot; for signed certs.</span>

<span class="c1"># Set serial number for signed certs.</span>
<span class="n">echo</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">ca</span><span class="o">-</span><span class="n">serial</span><span class="o">-</span><span class="n">no</span><span class="o">.</span><span class="n">txt</span>

<span class="c1"># Generate the root cert key.</span>
<span class="n">rm</span> <span class="o">-</span><span class="n">f</span> <span class="n">vgl</span><span class="o">-</span><span class="n">ca</span><span class="o">.</span><span class="n">key</span>
<span class="n">openssl</span> <span class="n">genrsa</span> <span class="o">-</span><span class="n">passout</span> <span class="k">pass</span><span class="p">:</span><span class="n">claudio</span> <span class="o">-</span><span class="n">des3</span> <span class="o">-</span><span class="n">out</span> <span class="n">vgl</span><span class="o">-</span><span class="n">ca</span><span class="o">.</span><span class="n">key</span> <span class="mi">2048</span>

<span class="c1"># Create the root cert.</span>
<span class="n">rm</span> <span class="o">-</span><span class="n">f</span> <span class="n">vgl</span><span class="o">-</span><span class="n">ca</span><span class="o">.</span><span class="n">pem</span>
<span class="n">PREFIX</span><span class="o">=</span><span class="n">vgl</span> <span class="n">DN</span><span class="o">=</span><span class="n">CA</span> <span class="n">openssl</span> <span class="n">req</span> <span class="o">-</span><span class="n">passin</span> <span class="k">pass</span><span class="p">:</span><span class="n">claudio</span> <span class="o">-</span><span class="n">config</span> <span class="o">./</span><span class="n">openssl</span><span class="o">.</span><span class="n">cnf</span> <span class="o">-</span><span class="n">x509</span> <span class="o">-</span><span class="n">new</span> <span class="o">-</span><span class="n">nodes</span> \
<span class="o">-</span><span class="n">key</span> <span class="n">vgl</span><span class="o">-</span><span class="n">ca</span><span class="o">.</span><span class="n">key</span> <span class="o">-</span><span class="n">sha256</span> <span class="o">-</span><span class="n">days</span> <span class="mi">36500</span> <span class="o">-</span><span class="n">batch</span> <span class="o">-</span><span class="n">out</span> <span class="n">vgl</span><span class="o">-</span><span class="n">ca</span><span class="o">.</span><span class="n">pem</span>

</pre></div>
</div>
<p>Once the root certificate has been generated, deployment certificates must be generated.
Client certificates used for mutual TLS can be generated with the script <a class="reference external" href="https://github.com/solidwallofcode/ts-docs/blob/apache/atc/ssh-gen-cert.sh">ssh-gen-cert.sh</a>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># SPDX-License-Identifier: Apache-2.0
# Bash script to generate signed certificates.

# the openssl.cnf file requires two environment variables
# PREFIX - the certificate prefix. This is used to decorate the distinguished name.
# DN - this must be &quot;CA&quot; for root certs and &quot;Signed&quot; for signed certs.

let N=$(cat ca-serial-no.txt) # signed certificate serial number.

# Generate key for the signed cert.
name=&quot;vgl-signed-${N}&quot;
key_file=&quot;${name}.key&quot;
cert_file=&quot;${name}.pem&quot;

rm -f ${key_file}
PREFIX=vgl DN=Signed openssl genrsa -passout pass:claudio -out ${key_file} 2048

# Generate the CSR for the signed cert.
rm -f tmp.csr
PREFIX=vgl DN=Signed openssl req -passin pass:claudio -config ./openssl.cnf -new -key ${key_file} -batch -out tmp.csr

# Generate the signed certificate.
rm -f ${cert_file}
PREFIX=vgl DN=Signed openssl x509 -passin pass:claudio -req -in tmp.csr -CA vgl-ca.pem -CAkey vgl-ca.key \
-set_serial 0$N -out ${cert_file} -days 36500 -sha256

# cleanup.
rm -f tmp.csr
let N=N+1
echo ${N} &gt; ca-serial-no.txt

</pre></div>
</div>
<p>Because Traffic Ops is the central hub for the components, those other components validate that the
certificate provided by the server (that is, by Traffic Ops) contains the host name used to connect
to Traffic Ops. Therefore if the common name is based on the CDN and not the Traffic Ops host, an
alternate script can be used which takes as a single argument the host name to embed in the SAN
data. The <a class="reference external" href="https://github.com/solidwallofcode/ts-docs/blob/apache/atc/ssh-gen-cert-with-host.sh">ssh-gen-cert-with-host.sh</a> script requires a host name as an argument which is embedded
in to the SAN data in way that validates with ATC components. The script uses the domain
“solidwallofcode.com” which should be changed to the domain being used for the CDN infrastructure.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># SPDX-License-Identifier: Apache-2.0
# Bash script to generate signed certificate for a specific host.

host=&quot;$1&quot;
if [ -z &quot;$host&quot; ] ; then
	echo &quot;Usage: $(basename $0) host&quot;
	exit 1
fi

# the openssl.cnf file requires two environment variables
# PREFIX - the certificate prefix. This is used to decorate the distinguished name.
# DN - this must be &quot;CA&quot; for root certs and &quot;Signed&quot; for signed certs.

let N=$(cat ca-serial-no.txt) # signed certificate serial number.

# Generate key for the signed cert.
name=&quot;vgl-signed-${host}&quot;
key_file=&quot;${name}.key&quot;
cert_file=&quot;${name}.pem&quot;

rm -f ${key_file}
PREFIX=vgl DN=Signed openssl genrsa -passout pass:claudio -out ${key_file} 2048

# Generate the CSR for the signed cert.
rm -f tmp.csr
PREFIX=vgl DN=Signed openssl req -passin pass:claudio -config ./openssl.cnf -new -key ${key_file} -addext &quot;subjectAltName=DNS:${host}&quot; -batch -out tmp.csr

# Generate the signed certificate. This is ugly but OpenSSL is broken - extensions (such as SANS) are flat out
# not carried over from the CSR to the certificate. It&#39;s listed as a bug, but no indication it will ever get fixed.
# Of course, there&#39;s no nice --addext option for certificate generation, so it&#39;s necessary to create a file
# for the extension data.
rm -f ${cert_file}
cat &gt; sans.tmp &lt;&lt;SANS 
[req_ext]
subjectAltName = @alt_names

[alt_names]
DNS.1 = ${host}
DNS.2 = ${host}.solidwallofcode.com
SANS

# Finally the certificate can be generated.
PREFIX=vgl DN=Signed openssl x509 -passin pass:claudio -req -in tmp.csr -CA vgl-ca.pem -CAkey vgl-ca.key \
-set_serial 0$N -out ${cert_file} -days 36500 -sha256 -extfile sans.tmp -extensions req_ext

# cleanup.
rm -f tmp.csr sans.tmp
let N=N+1
echo ${N} &gt; ca-serial-no.txt

</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Installing a certificate for use requires both the certificate file “.pem” and the key file
“.key”. The root certificate may need to be installed but the root key must <em>never</em> be deployed
on a production machine. It is used only to generate the signed certificates that are deployed.</p>
</div>
</section>
<section id="ancillary-technology">
<h2>Ancillary Technology<a class="headerlink" href="#ancillary-technology" title="Permalink to this headline">¶</a></h2>
<section id="dns">
<h3>DNS<a class="headerlink" href="#dns" title="Permalink to this headline">¶</a></h3>
<p>I used <code class="docutils literal notranslate"><span class="pre">bind</span></code> which is a standard package for Unix distributions. It’s a bit over powered but it’s
very easy to install.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">dnf</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">bind</span> <span class="n">bind</span><span class="o">-</span><span class="n">utils</span>
<span class="n">sudo</span> <span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span> <span class="o">--</span><span class="n">permanent</span> <span class="o">--</span><span class="n">add</span><span class="o">-</span><span class="n">service</span><span class="o">=</span><span class="n">dns</span> <span class="o">--</span><span class="n">zone</span><span class="o">=</span><span class="n">public</span>
<span class="n">sudo</span> <span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span> <span class="o">--</span><span class="n">reload</span>
<span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">enable</span> <span class="n">named</span>
<span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">start</span> <span class="n">named</span>
</pre></div>
</div>
<p>Domain searching is configured in “/etc/resolv.conf”.</p>
</section>
</section>
<section id="common-issues">
<h2>Common Issues<a class="headerlink" href="#common-issues" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p>If the Portal page comes up completely blank, this likely due to “traffic_portal” not being able
to connect to “traffic_ops”. Check that
*  “traffic_ops” host has port 443 open
*  The name of the “traffic_ops” host resolved correctly on the “traffic portal” host.
*  Check that “/etc/traffic_portal/conf/config.js” has been updated to have the “traffic ops” host.</p></li>
<li><p>If the initial admin login doesn’t work, verify the password tweaks have been done. If not,
it will be necessary to make then changes and then reset the password for the “traffic_ops”
user. This is most easily done by logging in to the Postgresql host with this command.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">psql</span> <span class="o">--</span><span class="n">host</span> <span class="mf">127.0.0.1</span> <span class="o">--</span><span class="n">user</span> <span class="n">traffic_ops</span>
</pre></div>
</div>
<p>There should be a password prompt - use the password specified in the “traffic ops” post install.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>\<span class="n">password</span>
</pre></div>
</div>
<p>Enter the password (twice) when prompted. Then exit Postgresql with the following command.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>\<span class="n">q</span>
</pre></div>
</div>
</li>
<li><p>TLS verification requires a match between the hostname in the URL and the certificate. I solved
this by putting the host name (base and FQDN) in the SAN data. A new certificate generation script
was required. If not used, the following problem occurs.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Login</span> <span class="n">error</span> <span class="n">Post</span> <span class="s2">&quot;https://atc-ops/api/3.1/user/login&quot;</span><span class="p">:</span> <span class="n">x509</span><span class="p">:</span> <span class="n">certificate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">valid</span> <span class="k">for</span> <span class="nb">any</span> <span class="n">names</span><span class="p">,</span> <span class="n">but</span> <span class="n">wanted</span> <span class="n">to</span> <span class="n">match</span> <span class="n">atc</span><span class="o">-</span><span class="n">ops</span>
</pre></div>
</div>
<p>This can be worked around by adding the option <code class="docutils literal notranslate"><span class="pre">--traffic-ops-insecure=true</span></code> to the <code class="docutils literal notranslate"><span class="pre">t3c</span></code>
command line but it’s better to have correct certificates.</p>
</li>
</ul>
</section>
<section id="issues">
<h2>Issues<a class="headerlink" href="#issues" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>To do monitoring, the “astats_over_http” plugin must be used, but this is not in the ATS 9
distribution and must be compiled separately.</p></li>
</ul>
</section>
<section id="to-do">
<h2>To Do<a class="headerlink" href="#to-do" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Recreate the Traffic Server VMs with a disk layout that supports raw device caching, then adjust
the Traffic Ops Parameters to use those raw devices.</p></li>
</ul>
</section>
<section id="footnotes">
<h2>Footnotes<a class="headerlink" href="#footnotes" title="Permalink to this headline">¶</a></h2>
<dl class="footnote brackets">
<dt class="label" id="id2"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>The Traffic Vault installation logic uses an SQL dump which requires the user name “traffic_vault”.
If that user doesn’t exist then no tables are created. Moreover if it does exist it will be the
owner of all of the tables. The user can be changed manually in the file and then the tables
created using</p>
<p>The first argument is the database name (which is normally “traffic_vault”). The input seems to
require the full path (likely due to <code class="docutils literal notranslate"><span class="pre">su</span></code> changing to the “postgres” user home directory).
I recommend making a copy of the dump file, changing that, and then using the copy to initialize
the database.</p>
</dd>
</dl>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/balcora-gate-400x400.jpg" alt="Logo"/>
            </a></p>
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Apache Traffic Control</a><ul>
<li><a class="reference internal" href="#generic-preparation">Generic Preparation</a></li>
<li><a class="reference internal" href="#traffic-ops">Traffic Ops</a></li>
<li><a class="reference internal" href="#traffic-portal">Traffic Portal</a></li>
<li><a class="reference internal" href="#traffic-server">Traffic Server</a></li>
<li><a class="reference internal" href="#administration">Administration</a><ul>
<li><a class="reference internal" href="#configuration">Configuration</a></li>
</ul>
</li>
<li><a class="reference internal" href="#tools">Tools</a></li>
<li><a class="reference internal" href="#ancillary-technology">Ancillary Technology</a><ul>
<li><a class="reference internal" href="#dns">DNS</a></li>
</ul>
</li>
<li><a class="reference internal" href="#common-issues">Common Issues</a></li>
<li><a class="reference internal" href="#issues">Issues</a></li>
<li><a class="reference internal" href="#to-do">To Do</a></li>
<li><a class="reference internal" href="#footnotes">Footnotes</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="../tsconfig-lua.en.html"
                        title="previous chapter">TSConfig / Lua</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../poc/poc-index.html"
                        title="next chapter">Partial Object Caching</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/atc/atc-index.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../poc/poc-index.html" title="Partial Object Caching"
             >next</a> |</li>
        <li class="right" >
          <a href="../tsconfig-lua.en.html" title="TSConfig / Lua"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">SWOC Docs</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Apache Traffic Control</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, amc@apache.org.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.1.2.
    </div>
  </body>
</html>