<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Cache Tool &#8212; AMC Traffic Server Documentation</title>
    
    <link rel="stylesheet" href="_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '8.0.x',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Command Registration" href="command-registration.en.html" />
    <link rel="prev" title="TSConfig / Lua" href="tsconfig-lua.en.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="command-registration.en.html" title="Command Registration"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="tsconfig-lua.en.html" title="TSConfig / Lua"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">SWOC Docs</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="ats-projects.en.html" accesskey="U">Traffic Server Projects</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/balcora-gate-400x400.jpg" alt="Logo"/>
            </a></p>
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Cache Tool</a><ul>
<li><a class="reference internal" href="#usage">Usage</a></li>
<li><a class="reference internal" href="#implementation">Implementation</a><ul>
<li><a class="reference internal" href="#directory-free-lists">Directory Free Lists</a></li>
<li><a class="reference internal" href="#rate-limiting">Rate Limiting</a></li>
</ul>
</li>
<li><a class="reference internal" href="#future-work">Future Work</a><ul>
<li><a class="reference internal" href="#content-scanning">Content Scanning</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="tsconfig-lua.en.html"
                        title="previous chapter">TSConfig / Lua</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="command-registration.en.html"
                        title="next chapter">Command Registration</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/cache-tool.en.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="toctree-wrapper compound" id="cache-tool">
</div>
<div class="section" id="id1">
<h1>Cache Tool<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<p>CacheTool is a command line tool for interacting with the Traffic Server cache. CacheTool started as a side
project to not only explore the Traffic Server cache but as a test bed for various other technologies of
interest to me, some of which are not really cache related. The goal was for the eventual release
these other technologies to open source as they matured. My view was the ancillary software
would be of better quality if validated in actual use first.</p>
<ul class="simple">
<li><a class="reference external" href="https://docs.trafficserver.apache.org/en/latest/developer-guide/internal-libraries/scalar.en.html">TS.Scalar</a>: a template for creating quantized integral types. This has been contributed to open source.</li>
<li><a class="reference external" href="https://docs.trafficserver.apache.org/en/latest/developer-guide/internal-libraries/memview.en.html">StringView</a>: read only view of string data. This has been contributed to open source.</li>
<li>Better <a class="reference internal" href="command-registration.en.html#command-registration"><span class="std std-ref">command line parsing</span></a> for action oriented tools like CacheTool and <strong class="program">traffic_ctl</strong>.</li>
<li>File system path and file handling class.</li>
<li>New data structures for the cache, as part of a larger scale redesign.</li>
<li>Improved stripe allocation algorithms.</li>
</ul>
<p>In addition to being a test bed, Cache Tool was intended to do useful work. An early  feature, stripe
re-allocation, was built to get around a bug in Traffic Server where a disk that was replaced would not
actually be used by the cache. This was originally a request from the Oath operations team but it
was sufficiently useful to another member of the community that I was persuaded to make CacheTool
public before it was even alpha quality.</p>
<p>Some of the intended features of CacheTool are</p>
<ul class="simple">
<li>Fix stripe allocation for unused disks.</li>
<li>List stripe data for a cache.</li>
<li>Clear / reset cache disks independently.</li>
<li>Provide cache directory analysis, as is done by passing <code class="code docutils literal"><span class="pre">--command</span> <span class="pre">check</span></code> to <strong class="program">traffic_server</strong> now, but with sufficiently low resource requirements it can be run on live system.</li>
<li>Cache directory diagnostics.</li>
<li>Cache scanning<ul>
<li>Scan to purge.</li>
<li>Statistical analysis.</li>
</ul>
</li>
<li>Cache repartitioning.<ul>
<li>Store additional information about cache configuration.<ul>
<li>More efficient and reliable examination.</li>
<li>Required to repartition, if values are always computed there is a chicken and egg problem.</li>
</ul>
</li>
<li>Update stripes to shift storage between directory and content (change effect average object size).</li>
<li>Maintain backwards compatibility and some forward compatibility. In particular it must be
possible to run 8.0 on a box and revert to 7.X without clearing the cache.</li>
</ul>
</li>
</ul>
<div class="section" id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h2>
<p>CacheTool has an action oriented interface with commands and subcommands (and possibly
subsubcommands, etc.), modeled on <strong class="program">traffic_ctl</strong>.</p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">list</span></code></dt>
<dd><p class="first">List information about the cache.</p>
<dl class="last docutils">
<dt><code class="docutils literal"><span class="pre">stripes</span></code></dt>
<dd>List per stripe information.</dd>
</dl>
</dd>
<dt><code class="docutils literal"><span class="pre">alloc</span></code></dt>
<dd><p class="first">Allocate cache space to stripes.</p>
<dl class="last docutils">
<dt><code class="docutils literal"><span class="pre">free</span></code></dt>
<dd>Allocate all free space to volumes.</dd>
<dt><code class="docutils literal"><span class="pre">sim</span></code></dt>
<dd>Simulate a full allocation of space to volumes.</dd>
</dl>
</dd>
<dt><code class="docutils literal"><span class="pre">dir</span></code></dt>
<dd><p class="first">Stripe directory operations.</p>
<dl class="last docutils">
<dt><code class="docutils literal"><span class="pre">freelist</span></code></dt>
<dd>Scan and fix segment free lists in the stripe.</dd>
<dt><code class="docutils literal"><span class="pre">stats</span></code></dt>
<dd>Print analytical data about the stripe directory.</dd>
</dl>
</dd>
</dl>
<p><code class="docutils literal"><span class="pre">span</span></code></p>
<blockquote>
<div><dl class="docutils">
<dt><code class="docutils literal"><span class="pre">clear</span></code></dt>
<dd><p class="first">Clear a span. All space in the stripe is consolidated in a single free block.
This command takes a list of span identifiers, each of which is cleared.</p>
<dl class="last docutils">
<dt><code class="docutils literal"><span class="pre">all</span></code></dt>
<dd>Clear all spans.</dd>
</dl>
</dd>
</dl>
</div></blockquote>
</div>
<div class="section" id="implementation">
<h2>Implementation<a class="headerlink" href="#implementation" title="Permalink to this headline">¶</a></h2>
<p>This section has internal implementation notes.</p>
<div class="section" id="directory-free-lists">
<h3>Directory Free Lists<a class="headerlink" href="#directory-free-lists" title="Permalink to this headline">¶</a></h3>
<p>Each segment in a directory has a free list. It is possible for this to become corrupted and have a
loop in the list. There is some logic which can be conditionally compiled in the Traffic Server core that will
place a maximum length on the free list. Upon detection an error is generated.</p>
<p>The CacheTool will detect free list loops more directly by using a <code class="code docutils literal"><span class="pre">std::bitset</span></code> to mark
directory entries that have been encountered while walking the free list. If a duplicate is detected
(indicating a loop) then rather than attempt any sort of complex repair, the CacheTool will clear
and then reconstruct the free list in a way similar to how the free list was constructed during
stripe initialization. This is primarily constructing the list so that directories at higher layers
in the buckets are earlier in the free list.</p>
</div>
<div class="section" id="rate-limiting">
<h3>Rate Limiting<a class="headerlink" href="#rate-limiting" title="Permalink to this headline">¶</a></h3>
<p>While in general the CacheTool will be run while Traffic Server is offline it will frequently be desirable to
be able to run CacheTool while Traffic Server is also running. To make this possible CacheTool will need to be
able to rate limit its disk reading. This will be specified by placing a limit on the number of
bytes per second that will be read. It is not expected this limiting will be exact but it should be
reasonably close. An possible implementation is to start with the per second limit as a read limit
and then after the read completes, subtract the size of the read and add the limit value for each
second that has passed. It may also be good to limit the addition to a maximum number of seconds to
further restrict I/O when the disks are under excessive load.</p>
</div>
</div>
<div class="section" id="future-work">
<h2>Future Work<a class="headerlink" href="#future-work" title="Permalink to this headline">¶</a></h2>
<p>This section contains some of the larger work planned for the CacheTool.</p>
<div class="section" id="content-scanning">
<h3>Content Scanning<a class="headerlink" href="#content-scanning" title="Permalink to this headline">¶</a></h3>
<p>A key feature is the ability to scan content stored in the cache. This is extremely expensive in
terms of disk I/O. This is of less concern if the system is offline, in which case CacheTool can
consume all availale disk I/O. Even in that case, however, the amount of data to be read can still
large enough to make the overall runtime too large if the data is read in a simplistic fashion.</p>
<p>The primary purpose of cache scanning is to extract the request and response headers. All of this
data is contained in the first fragment of the cached object. This is noted in the directory entry
which means disk reads can be restricted to only these fragments rather than a full scan of the
content area.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="command-registration.en.html" title="Command Registration"
             >next</a> |</li>
        <li class="right" >
          <a href="tsconfig-lua.en.html" title="TSConfig / Lua"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">SWOC Docs</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="ats-projects.en.html" >Traffic Server Projects</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, amc@apache.org.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.5.
    </div>
  </body>
</html>