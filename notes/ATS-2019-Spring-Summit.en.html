
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>2019 Spring Summit &#8212; AMC Traffic Server Documentation</title>
    <link rel="stylesheet" href="../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="2018 Fall Summit" href="ATS-2018-Fall-Summit.en.html" />
    <link rel="prev" title="Partial Caching Initial Design" href="../poc/archive-partial-object-caching-prototype.en.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="ATS-2018-Fall-Summit.en.html" title="2018 Fall Summit"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../poc/archive-partial-object-caching-prototype.en.html" title="Partial Caching Initial Design"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">SWOC Docs</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/balcora-gate-400x400.jpg" alt="Logo"/>
            </a></p>
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">2019 Spring Summit</a><ul>
<li><a class="reference internal" href="#opening-remarks">Opening remarks</a></li>
<li><a class="reference internal" href="#plugin-api-and-webassembly">Plugin API and WebAssembly</a></li>
<li><a class="reference internal" href="#quic-updates">QUIC Updates</a></li>
<li><a class="reference internal" href="#quic-deployment">QUIC Deployment</a></li>
<li><a class="reference internal" href="#ats-internals">ATS Internals</a><ul>
<li><a class="reference internal" href="#aoi">AOI</a></li>
<li><a class="reference internal" href="#dns">DNS</a></li>
<li><a class="reference internal" href="#transform-connections">Transform Connections</a></li>
</ul>
</li>
<li><a class="reference internal" href="#thread-scheduling">Thread Scheduling</a></li>
<li><a class="reference internal" href="#cwiki-changes">CWiki Changes</a></li>
<li><a class="reference internal" href="#plugin-reload">Plugin Reload</a></li>
<li><a class="reference internal" href="#parent-selection-and-traffic-manager">Parent Selection and traffic_manager</a></li>
<li><a class="reference internal" href="#footnotes">Footnotes</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="../poc/archive-partial-object-caching-prototype.en.html"
                        title="previous chapter">Partial Caching Initial Design</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="ATS-2018-Fall-Summit.en.html"
                        title="next chapter">2018 Fall Summit</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/notes/ATS-2019-Spring-Summit.en.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="spring-summit">
<h1>2019 Spring Summit<a class="headerlink" href="#spring-summit" title="Permalink to this headline">¶</a></h1>
<p>These are my notes from the 2019 Spring Summit in Beijing.</p>
<div class="section" id="opening-remarks">
<h2>Opening remarks<a class="headerlink" href="#opening-remarks" title="Permalink to this headline">¶</a></h2>
<p>The primary message was we as a community need to do better about testing at production levels.
Bringing ATS 8.0.x to production quality has been a long struggle and 8.1.x is not going well either.
A problem I see is that as the production testing takes longer, the difference between the LTS release
and the next release gets larger, which makes the whole process take longer. This is a degenerative
spiral that will end badly.</p>
<p>We need to do better about reviewing pull requests, in particular to get reviews across company
silos. I think people should do this also because it’s good for the reviewer.</p>
</div>
<div class="section" id="plugin-api-and-webassembly">
<h2>Plugin API and WebAssembly<a class="headerlink" href="#plugin-api-and-webassembly" title="Permalink to this headline">¶</a></h2>
<p>Web assembly is the new fad of a byte code executor which can be run in a web browser. The
ostensible point is to subsume the variety of languages currently used in active web pages to a
single basic feature <a class="footnote-reference brackets" href="#zend" id="id1">1</a>. Developers would be able to write code in a variety of lanagues, which is
condensed to byte code and then executed in a engine based run time environment.</p>
<p>Kit is concerned about the long term viability of the Lua community, given that luajit and other
libraries have been abandoned. If ATS has a WebAssembly engine, then plugins could be done the
same way.</p>
<p>All of this is still very wide open - many different incompatible tool chains floating around.</p>
<div class="topic">
<p class="topic-title first">Commentary</p>
<p>It occurs to me as I write this that there may be some performance implications. It’s hard to
believe the byte code machine can be as fast as native C code. We have some plugins where plugin
performance is a significant issue.</p>
</div>
</div>
<div class="section" id="quic-updates">
<h2>QUIC Updates<a class="headerlink" href="#quic-updates" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p>HTTP over QUIC is now ‘HTTP/3”.</p>
<blockquote>
<div><ul class="simple">
<li><p>Multipath is coming, but final docuemnt not due until May 2020.</p></li>
</ul>
</div></blockquote>
</li>
<li><p>Still targeting ATS 9.0.</p>
<ul class="simple">
<li><p>OpenSSL doesn’t support API required for QUIC (any supported release at this time). Masaori
said there are not current plans to ever support this API. This would require a custome openSSL
build for ATS to use openSSL and QUIC.</p></li>
<li><p>BoringSSL has QUIC API.</p></li>
<li><p>Results from IETF 103, 104 QUIC WG tested against 16 other versions.</p>
<ul>
<li><p>Depending HTTP/2 outbound for certain client side features.</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Working on performance improvements, implementation was very slow.</p></li>
<li><p>Cleanup of loading certificates from “ssl_multicert.config”.</p></li>
<li><p>Review is going to be hard - already 43K lines changed.</p></li>
</ul>
<p>There was a long discussion on how and when to bring this in to master.</p>
<ul class="simple">
<li><p>A key issue is how many changes are expected in the future. Moving to master will mean a large
slow down in commit speed, because reviews will be required for each PR. Currently the QUIC branch
has 1300 commits over two years, which is a very high velocity for this project.</p></li>
</ul>
<p>One problem is that if QUIC doesn’t go in to ATS 9, it will be another 12-18 months before it is
released in a supported version.</p>
</div>
<div class="section" id="quic-deployment">
<h2>QUIC Deployment<a class="headerlink" href="#quic-deployment" title="Permalink to this headline">¶</a></h2>
<p>This was about actually deploying a variant of the ATS QUIC implementation (draft 12) in production.</p>
<p>Reasons for QUIC</p>
<ul class="simple">
<li><p>RTT costs.</p></li>
<li><p>Head of Line blocking</p></li>
<li><p>Mobile connection switching vs. QUIC routing. Possibly load balancers can route by DCID embedded
in QUIC packets. Unclear this is commerciall available without local changes. DCID contents
encode the <code class="docutils literal notranslate"><span class="pre">ET_NET</span></code> thread in this deployment. <code class="docutils literal notranslate"><span class="pre">UDP_NET</span></code> threads get packets at random
and reschedule to the appropriate <code class="docutils literal notranslate"><span class="pre">ET_NET</span></code> thread.</p></li>
</ul>
<div class="topic">
<p class="topic-title first">Commentary</p>
<p>I’m not sure how of much of a QUIC advantage these things are any more. Most (all?) of them have
been migrated back into TCP stacks. E.g. <a class="reference external" href="http://multipath-tcp.org">MPTCP</a>.</p>
</div>
<p>Using “BRR” congestion control vs. “New Reno” which is the IETF QUIC recommendation. Claims 10x
speed improvement for transfering 1MB in 5% packet loss environment. This approximates some third
world networks.</p>
<p>Using <a class="reference external" href="https://mailarchive.ietf.org/arch/msg/tls/gDzOxgKQADVfItfC4NyW3ylr7yc">SSL_OP_NO_ANTI_REPLAY</a>. Getting 79%
~ 98% sessions reuse for 0-RTT.</p>
</div>
<div class="section" id="ats-internals">
<h2>ATS Internals<a class="headerlink" href="#ats-internals" title="Permalink to this headline">¶</a></h2>
<p>A discussion of ATS internal architecture (based on 6.0.x).</p>
<div class="section" id="aoi">
<h3>AOI<a class="headerlink" href="#aoi" title="Permalink to this headline">¶</a></h3>
<p>Asynchronous I/O. This is a thread based module that does blocking I/O internally and provides
an asynchronous interface using mutex locking and lockless queues.</p>
<div class="topic">
<p class="topic-title first">Commentary</p>
<p>Should look at using atomics instead of an insert mutex for the AIO queue. That might be
problematic for removes.</p>
</div>
<div class="topic">
<p class="topic-title first">Commentary</p>
<p>As far as oknet can tell, the AIO priority isn’t used. This implies we may want to look at
removing the internal sorted priority queue, since it’s not doing anything useful.</p>
</div>
<p>There is also the native <a class="reference external" href="http://man7.org/linux/man-pages/man7/aio.7.html">Linux AIO</a> system.
Structured similarly to <a class="reference external" href="http://man7.org/linux/man-pages/man7/epoll.7.html">epoll</a>.</p>
</div>
<div class="section" id="dns">
<h3>DNS<a class="headerlink" href="#dns" title="Permalink to this headline">¶</a></h3>
<p>Table of in flight DNS queries, with de-dupping. Each entry can have a list of continuations waiting
on the results for that query. Can have dedicated DNS thread or share with an <code class="docutils literal notranslate"><span class="pre">ET_NET</span></code> thread.</p>
</div>
<div class="section" id="transform-connections">
<h3>Transform Connections<a class="headerlink" href="#transform-connections" title="Permalink to this headline">¶</a></h3>
<p>This is a chain of continuations that process data serially. There is a special <code class="code docutils literal notranslate"><span class="pre">TransformTerminus</span></code>
created by the core which anchor the chain.</p>
<div class="topic">
<p class="topic-title first">Commentary</p>
<p>I need to get back to providing some more control in this chain. The idea at one point was to
be able to pass hints along about how the transform was modifying the content, particularly
with regard to length. There would be potential performance improvements if a transform could
mark itself as read only or length preserving.</p>
</div>
<p>The diagrams were done in <a class="reference external" href="https://www.omnigroup.com/omnigraffle">OmniGraffle</a>.</p>
</div>
</div>
<div class="section" id="thread-scheduling">
<h2>Thread Scheduling<a class="headerlink" href="#thread-scheduling" title="Permalink to this headline">¶</a></h2>
<p>The real point of all of this is to support thread affinity. The API is designed to make this
behave in an orderly and expected way. Conceptually each thread can have an affine thread which
belongs to a specific thread pool. This makes it possible to easily schedule a continuation on
the same thread every time, particularly when switching threads. E.g. something does a DNS request
and needs to be scheduled back to <code class="docutils literal notranslate"><span class="pre">ET_NET</span></code> from <code class="docutils literal notranslate"><span class="pre">ET_DNS</span></code>.</p>
<p>Talk about clean shutdown, primarily to avoid crashes from out of order clean up of static data.</p>
<p>JEMalloc differences are small - order of 1-2% more for JEMalloc. However, having some locking
issues under stress, still investigating.</p>
</div>
<div class="section" id="cwiki-changes">
<h2>CWiki Changes<a class="headerlink" href="#cwiki-changes" title="Permalink to this headline">¶</a></h2>
<p>Generally agreed. The concensus was</p>
<ul class="simple">
<li><p>If it’s about the software, it goes in Sphinx in the code base.</p></li>
<li><p>If it’s about the community, it goes in the Wiki.</p></li>
<li><p>Projects go to github projects.</p></li>
</ul>
</div>
<div class="section" id="plugin-reload">
<h2>Plugin Reload<a class="headerlink" href="#plugin-reload" title="Permalink to this headline">¶</a></h2>
<p>Goal is to change plugin code by loading new versions of dynamic libraries, cleaning up the old
ones. Old code needs to be removed to do cleanup and to release resources.</p>
<p>One issue is the internal dynamic library loader tracks the loaded library files, not reloading if
already loaded. This isn’t affected by replacing the dynmaic library file.</p>
<p>This change does Continuation context tracking, using the mechanism from the Plugin Coordination
project. That is, each Continuation has a member that is a pointer to a context. When a Continuation
is created the context is passed from the executing Continuation to the Continuation being created.</p>
<p>This is only for remap plugins and remap configuration reload.</p>
<p>The context objects are reference counted so that the context is preserved as long as a Continuation
is using it. This leads to the problem with plugins that schedules events after a transaction or
does a persistent periodic task. In this case it would be possible to accumulate a large number of
old plugin context objects. There is also the problem that the plugin could have multiple instances
running concurrently. To me this seems to overlap with Fei’s work on clean shutdown. This is
fundamentally the same, where a version of a plugin needs to shut down in a clean manner. Because
this particular case it’s less of an issue because there is already a hook for shutting down remap
plugin instances.</p>
<p>Leif went on at great length about optimizing the reloading of the dynamic libraries. It would be
worthwhile to keep a modified time stamp for each dynamic library and only actually reload if that
time has changed. This is because it’s quite unusual for the dynamic library to change, it’s a rare
but critical case.</p>
<p>In the long run we want to unify global and remap plugins, so there are only plugins. This means
being able to reload any plugin, and having hooks for global plugins to indicate load, reload, and
shutdown. The plugin context structures would also be unified. In the not so long term, we can look
at providing hooks for global plugins to be informed of dynamic library reloads.</p>
<p>Discussion on <code class="code docutils literal notranslate"><span class="pre">TSRemapOSResponse</span></code> - what is the use of this? Kit said it was because it is
always called, in contrast to <code class="code docutils literal notranslate"><span class="pre">ReadResponseHdrHook</span></code> which is only called after a successful
connection to the upstream. Using both enables detecting upstream connection failures.</p>
<p>Discussion on whether this should be optional - is that useful? One argument is that it would ease
transition. Is it sufficient to just make the “only reload if the timestamp changed” update?</p>
</div>
<div class="section" id="parent-selection-and-traffic-manager">
<h2>Parent Selection and traffic_manager<a class="headerlink" href="#parent-selection-and-traffic-manager" title="Permalink to this headline">¶</a></h2>
<p>Project goal is to be able to have more complex selection criteria for upstream selection.</p>
<p>Added ability mark upstream status, via <strong class="program">traffic_ctl</strong> or plugin API. This includes
reasons for the status.</p>
<p>A major problem has been the only data that flows <em>from</em> <strong class="program">traffic_server</strong> <em>to</em>
<strong class="program">traffic_manager</strong> is statistics, and so that has been used. However this approach
does not scale well. This is another aspect of how the internal RPC is messed up.</p>
<p>Working on</p>
<ul class="simple">
<li><p>updating to YAML for “parent.config” and better integration with “remap.config”.</p></li>
<li><p>API support for tweaking selection strategies.</p></li>
</ul>
<p>The only thing that <strong class="program">traffic_manager</strong> provides that is not easily put into
<strong class="program">traffic_server</strong> is the external process RPC. To me, this is once again wrapped up with
the overall brokenness of the RPC.</p>
<p>Discussion on how the external connectivity for the RPC - should it be done via the normal proxy
ports or keep it as a specialized communication channel (e.g. via UNIX domain sockets). Long
discussion about this. I think there is more concern about the complexity of the transport than is
warrented. I also think even if the overall implementations are different between a custom channel
and an HTTP based channel are different, the core implementation is identical. That part is the
request parsing, dispatch, and response generation.</p>
<p>Kit brought up the issue of <strong class="program">traffic_manager</strong> keeping the proxy ports open means the listen
queue for the proxy ports is also maintained across <strong class="program">traffic_server</strong> restarts. It would be
possible to write a custom wrapper that does this in very little code. Miles pointed out this can
also be handled by fronting load balancers, even though they are on different hardware. From the
point of view of the inbound client this is irrelevant.</p>
</div>
<div class="section" id="footnotes">
<h2>Footnotes<a class="headerlink" href="#footnotes" title="Permalink to this headline">¶</a></h2>
<dl class="footnote brackets">
<dt class="label" id="zend"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>This reminds me very much of <a class="reference external" href="https://www.php.net/manual/en/internals2.ze1.php">Zend Project</a>.
I’m not sure why this wasn’t used, but maybe it was.</p>
</dd>
</dl>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="ATS-2018-Fall-Summit.en.html" title="2018 Fall Summit"
             >next</a> |</li>
        <li class="right" >
          <a href="../poc/archive-partial-object-caching-prototype.en.html" title="Partial Caching Initial Design"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">SWOC Docs</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, amc@apache.org.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.0.1.
    </div>
  </body>
</html>